<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>โปรแกรมคำนวณงานระบบปรับอากาศและระบายอากาศ (HVAC Integrated Tool)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f0f4f8;
        }
        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }
        .input-group label {
            font-size: 0.9rem;
            color: #475569;
            font-weight: 600;
        }
        .input-field {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; 
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 4px;
        }
        
        /* Toggle Switch */
        .toggle-checkbox:checked {
            transform: translateX(100%);
            border-color: #3b82f6;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #3b82f6;
        }

        /* Range Slider */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 0 2px rgba(0,0,0,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #cbd5e1;
            border-radius: 2px;
        }
        
        /* Animations */
        .bubble-pop {
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.8) translateY(10px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .cursor-grab { cursor: grab; }
        .cursor-grab:active { cursor: grabbing; }
    </style>
</head>
<body class="text-slate-800 flex flex-col min-h-screen">

    <!-- Navigation Tabs -->
    <div class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 md:px-8">
            <div class="flex items-center justify-between h-16">
                <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    <i data-lucide="wind" class="text-blue-600"></i>
                    <span class="hidden md:inline">HVAC Integrated Tool</span>
                    <span class="md:hidden">HVAC Tool</span>
                </h1>
                <div class="flex space-x-1 bg-slate-100 p-1 rounded-lg overflow-x-auto">
                    <button onclick="switchTab('calc')" id="tab-calc" class="whitespace-nowrap px-4 py-2 rounded-md text-sm font-semibold transition-all shadow-sm bg-white text-blue-600">
                        <i data-lucide="calculator" class="inline w-4 h-4 mr-1"></i> ท่อลม (Duct)
                    </button>
                    <button onclick="switchTab('visual')" id="tab-visual" class="whitespace-nowrap px-4 py-2 rounded-md text-sm font-semibold text-slate-500 hover:text-slate-700 transition-all">
                        <i data-lucide="monitor-play" class="inline w-4 h-4 mr-1"></i> จำลองภาพ (Visual)
                    </button>
                    <button onclick="switchTab('vfd')" id="tab-vfd" class="whitespace-nowrap px-4 py-2 rounded-md text-sm font-semibold text-slate-500 hover:text-slate-700 transition-all">
                        <i data-lucide="activity" class="inline w-4 h-4 mr-1"></i> VFD / กฎของพัดลม
                    </button>
                    <!-- New Cost Tab -->
                    <button onclick="switchTab('cost')" id="tab-cost" class="whitespace-nowrap px-4 py-2 rounded-md text-sm font-semibold text-slate-500 hover:text-slate-700 transition-all">
                        <i data-lucide="coins" class="inline w-4 h-4 mr-1"></i> วิเคราะห์ความคุ้มค่า
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto p-4 md:p-8 w-full flex-grow">
        
        <!-- ================= 1. DUCT CALCULATOR VIEW ================= -->
        <div id="view-calc" class="block fade-in">
            <header class="mb-6 text-center md:text-left flex flex-col md:flex-row items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">Duct Calculator</h2>
                    <p class="text-slate-500 text-sm">คำนวณขนาดท่อลม แรงดัน และแดมเปอร์</p>
                </div>
                <button onclick="resetDuctValues()" class="mt-4 md:mt-0 px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-lg text-sm font-semibold transition flex items-center gap-2">
                    <i data-lucide="rotate-ccw" class="w-4 h-4"></i> รีเซ็ตค่า
                </button>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Input Section -->
                <div class="lg:col-span-1 space-y-6">
                      <!-- Simulation Mode Toggle -->
                      <div class="card p-4 border-l-4 border-purple-500 flex items-center justify-between">
                        <div>
                            <h3 class="font-bold text-slate-700">โหมดจำลองพัดลม</h3>
                            <p class="text-xs text-slate-500">Fan Curve Simulation</p>
                        </div>
                        <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="fanModeToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300 left-0 transition-all duration-300" onchange="calculateDuct()"/>
                            <label for="fanModeToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer transition-colors duration-300"></label>
                        </div>
                    </div>

                    <!-- Dimensions -->
                    <div class="card p-6 border-l-4 border-blue-500">
                        <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                            <i data-lucide="ruler" class="w-5 h-5 text-blue-500"></i> ขนาดท่อลม
                        </h2>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="input-group">
                                <label for="width">ความกว้าง (mm)</label>
                                <input type="number" id="width" class="input-field mt-1" value="600" oninput="calculateDuct()">
                            </div>
                            <div class="input-group">
                                <label for="height">ความสูง (mm)</label>
                                <input type="number" id="height" class="input-field mt-1" value="400" oninput="calculateDuct()">
                            </div>
                        </div>
                        <div class="mt-2 text-xs text-slate-400 text-right" id="areaDisplay">Area: 0.24 m²</div>
                    </div>

                    <!-- Inlet Conditions -->
                    <div class="card p-6 border-l-4 border-emerald-500">
                        <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                            <i data-lucide="log-in" class="w-5 h-5 text-emerald-500"></i> สภาวะด้านเข้า
                        </h2>
                        <div class="space-y-4">
                            <div class="input-group">
                                <label for="airflowIn">Airflow Rate (CMS)</label>
                                <div class="relative">
                                    <input type="number" id="airflowIn" class="input-field mt-1 pl-10" value="7.0" step="0.1" oninput="calculateDuct()">
                                    <i data-lucide="wind" class="w-4 h-4 text-slate-400 absolute left-3 top-4"></i>
                                </div>
                            </div>
                            <div class="input-group">
                                <label for="pressureIn">Static Pressure (Pa)</label>
                                <div class="relative">
                                    <input type="number" id="pressureIn" class="input-field mt-1 pl-10" value="7850" oninput="calculateDuct()">
                                    <i data-lucide="gauge" class="w-4 h-4 text-slate-400 absolute left-3 top-4"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Damper Control -->
                    <div class="card p-6 border-l-4 border-orange-500">
                        <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                            <i data-lucide="settings-2" class="w-5 h-5 text-orange-500"></i> แดมเปอร์
                        </h2>
                        <div class="mb-2 flex justify-between items-center">
                            <label class="font-semibold text-slate-600">Position</label>
                            <span id="damperPercentDisplay" class="bg-orange-100 text-orange-700 px-2 py-1 rounded font-bold">50%</span>
                        </div>
                        <input type="range" id="damperOpen" min="0" max="100" value="50" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="calculateDuct()">
                        <div class="mt-2 text-xs text-slate-400 text-center">Slide to adjust damper opening</div>
                    </div>
                </div>

                <!-- Results Section -->
                <div class="lg:col-span-2 space-y-6">
                    <div class="card p-6 h-full flex flex-col">
                        <h2 class="text-2xl font-bold text-slate-800 mb-6 border-b pb-2">ผลลัพธ์การคำนวณ (Results)</h2>

                        <!-- Insight Box -->
                        <div id="resultInsightBox" class="mb-6 p-4 rounded-lg bg-indigo-50 border border-indigo-100 hidden">
                            <div class="flex gap-3">
                                <div class="mt-0.5"><i data-lucide="lightbulb" class="w-5 h-5 text-indigo-600"></i></div>
                                <div>
                                    <h4 class="text-sm font-bold text-indigo-800">บทวิเคราะห์ (Analysis)</h4>
                                    <p id="resultInsightText" class="text-sm text-indigo-700 mt-1"></p>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 flex-grow">
                            <!-- Airflow -->
                            <div class="bg-emerald-50 rounded-xl p-5 border border-emerald-100">
                                <p class="text-emerald-600 font-semibold text-sm uppercase tracking-wider">Airflow Rate</p>
                                <h3 class="text-4xl font-bold text-slate-800 mt-2" id="flowCMS">---</h3>
                                <p class="text-slate-500 text-sm">m³/s (CMS)</p>
                                <div class="mt-4 pt-4 border-t border-emerald-200">
                                    <div class="flex justify-between text-sm">
                                        <span class="text-slate-600">Velocity:</span>
                                        <span class="font-bold text-slate-700" id="velocityOut">0 m/s</span>
                                    </div>
                                    <div class="flex justify-between text-sm mt-1">
                                        <span class="text-slate-600">Volume (CFM):</span>
                                        <span class="font-bold text-slate-700" id="flowCFM">0 ft³/min</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Pressure -->
                            <div class="bg-blue-50 rounded-xl p-5 border border-blue-100">
                                <p class="text-blue-600 font-semibold text-sm uppercase tracking-wider">Outlet Pressure</p>
                                <h3 class="text-4xl font-bold text-slate-800 mt-2" id="pressureOut">---</h3>
                                <p class="text-slate-500 text-sm">Pa (Pascals)</p>
                                <div class="mt-4 pt-4 border-t border-blue-200">
                                    <div class="flex justify-between text-sm">
                                        <span class="text-slate-600">Pressure Drop:</span>
                                        <span class="font-bold text-red-500" id="pressureDrop">0 Pa</span>
                                    </div>
                                    <div class="w-full bg-slate-200 rounded-full h-1.5 mt-2">
                                        <div id="pressureBar" class="bg-blue-500 h-1.5 rounded-full" style="width: 100%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Formulas -->
                        <div class="mt-8 bg-slate-50 p-4 rounded-lg border border-slate-200">
                            <h4 class="font-bold text-slate-700 mb-2 flex items-center gap-2">
                                <i data-lucide="info" class="w-4 h-4"></i> หลักการคำนวณ
                            </h4>
                            <div id="logicExplanation" class="text-sm text-slate-600 space-y-1"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= 2. VISUALIZER VIEW ================= -->
        <div id="view-visual" class="hidden fade-in">
            <div class="bg-slate-900 rounded-xl overflow-hidden shadow-2xl border border-slate-700 relative">
                <!-- Toolbar -->
                <div class="bg-slate-800 p-4 flex justify-between items-center border-b border-slate-700 relative z-10">
                    <div class="flex items-center gap-3">
                        <div class="w-3 h-3 rounded-full bg-red-500"></div>
                        <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                        <div class="w-3 h-3 rounded-full bg-green-500"></div>
                        <span class="text-slate-300 font-mono text-sm ml-2">SYSTEM_MONITOR :: LIVE</span>
                    </div>
                    <div class="flex items-center gap-4">
                         <div id="visModeDisplay" onclick="toggleFanMode()" class="px-3 py-1 rounded text-[10px] font-mono font-bold bg-blue-500/20 text-blue-400 border border-blue-500/50 shadow-[0_0_10px_rgba(59,130,246,0.2)] transition-colors duration-300 cursor-pointer hover:bg-blue-500/30 select-none" title="Click to toggle mode">
                             MODE: STANDARD DESIGN
                         </div>
                         <div class="text-xs text-slate-500 font-mono hidden md:block">RENDERING: CANVAS 2D</div>
                    </div>
                </div>

                <!-- Main Canvas Area -->
                <div class="relative h-[500px] w-full bg-[#0f172a] overflow-hidden">
                    <canvas id="ductCanvas" class="w-full h-full block"></canvas>
                    
                    <!-- BUBBLES -->
                    <!-- Inlet Pressure -->
                    <div id="bubble_inlet" class="bubble-pop absolute top-[20%] left-8 bg-slate-800/90 backdrop-blur p-3 rounded-xl border border-blue-500/50 shadow-lg shadow-blue-500/10 cursor-grab z-20">
                        <div class="flex items-center gap-2 mb-1 pointer-events-none">
                            <div class="w-2 h-2 rounded-full bg-blue-500"></div>
                            <div class="text-[10px] text-slate-400 uppercase tracking-widest">Inlet Pressure</div>
                        </div>
                        <div class="font-mono text-xl font-bold text-blue-400 pointer-events-none" id="visPin">7850</div>
                         <div class="text-[10px] text-slate-500 pointer-events-none">Pa</div>
                         <div class="w-0 h-0 border-l-[6px] border-l-transparent border-r-[6px] border-r-transparent border-t-[8px] border-t-slate-800/90 absolute left-4 -bottom-2 pointer-events-none"></div>
                    </div>

                    <!-- Inlet Airflow -->
                    <div id="bubble_airflow_in" class="bubble-pop absolute top-[40%] left-[20%] bg-slate-800/90 backdrop-blur p-3 rounded-xl border border-cyan-500/50 shadow-lg shadow-cyan-500/10 cursor-grab z-20">
                         <div class="flex items-center gap-2 mb-1 pointer-events-none">
                            <div class="w-2 h-2 rounded-full bg-cyan-500"></div>
                            <div class="text-[10px] text-slate-400 uppercase tracking-widest">Inlet Airflow</div>
                        </div>
                        <div class="font-mono text-xl font-bold text-cyan-400 pointer-events-none" id="visFlowIn">---</div>
                        <div class="text-[10px] text-slate-500 pointer-events-none">m³/s</div>
                         <div class="w-0 h-0 border-l-[6px] border-l-transparent border-r-[6px] border-r-transparent border-t-[8px] border-t-slate-800/90 absolute left-4 -bottom-2 pointer-events-none"></div>
                    </div>

                    <!-- Damper -->
                    <div id="bubble_damper" class="bubble-pop absolute top-[75%] left-1/2 transform -translate-x-1/2 bg-slate-800/90 backdrop-blur p-3 rounded-xl border border-orange-500/50 shadow-lg shadow-orange-500/10 cursor-grab z-20">
                         <div class="flex items-center gap-2 mb-1 justify-center pointer-events-none">
                            <i data-lucide="settings-2" class="w-3 h-3 text-orange-500"></i>
                            <div class="text-[10px] text-slate-400 uppercase tracking-widest">Damper</div>
                        </div>
                        <div class="font-mono text-xl font-bold text-orange-400 text-center pointer-events-none" id="visDamper">50%</div>
                         <div class="w-0 h-0 border-l-[6px] border-l-transparent border-r-[6px] border-r-transparent border-b-[8px] border-b-slate-800/90 absolute left-1/2 -translate-x-1/2 -top-2 pointer-events-none"></div>
                    </div>

                    <!-- Flow Rate -->
                    <div id="bubble_flow" class="bubble-pop absolute top-[40%] left-[65%] bg-slate-800/90 backdrop-blur p-3 rounded-xl border border-emerald-500/50 shadow-lg shadow-emerald-500/10 cursor-grab z-20">
                         <div class="flex items-center gap-2 mb-1 pointer-events-none">
                            <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                            <div class="text-[10px] text-slate-400 uppercase tracking-widest">Actual Flow</div>
                        </div>
                        <div class="font-mono text-xl font-bold text-emerald-400 pointer-events-none" id="visFlow">---</div>
                        <div class="text-[10px] text-slate-500 pointer-events-none">m³/s</div>
                         <div class="w-0 h-0 border-l-[6px] border-l-transparent border-r-[6px] border-r-transparent border-t-[8px] border-t-slate-800/90 absolute left-1/2 -translate-x-1/2 -bottom-2 pointer-events-none"></div>
                    </div>

                    <!-- Outlet Pressure -->
                    <div id="bubble_outlet" class="bubble-pop absolute top-[20%] right-8 bg-slate-800/90 backdrop-blur p-3 rounded-xl border border-green-500/50 shadow-lg shadow-green-500/10 text-right cursor-grab z-20">
                         <div class="flex items-center gap-2 mb-1 justify-end pointer-events-none">
                            <div class="text-[10px] text-slate-400 uppercase tracking-widest">Outlet Pressure</div>
                            <div class="w-2 h-2 rounded-full bg-green-500"></div>
                        </div>
                        <div class="font-mono text-xl font-bold text-green-400 pointer-events-none" id="visPout">---</div>
                        <div class="text-[10px] text-slate-500 pointer-events-none">Pa</div>
                         <div class="w-0 h-0 border-l-[6px] border-l-transparent border-r-[6px] border-r-transparent border-t-[8px] border-t-slate-800/90 absolute right-4 -bottom-2 pointer-events-none"></div>
                    </div>
                </div>
            </div>
            <div class="mt-4 text-center text-slate-500 text-sm">
                * กราฟิกแสดงการไหลจำลองจากค่าที่คำนวณได้จริง (Simulation based on calculated physics)
            </div>
        </div>

        <!-- ================= 3. VFD SIMULATOR VIEW ================= -->
        <div id="view-vfd" class="hidden fade-in">
             <!-- VFD Header -->
             <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100 mb-6">
                <div class="p-6 border-l-8 border-blue-600 bg-white">
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900 mb-2">
                                เครื่องคำนวณกฎของพัดลม (VFD Simulator)
                            </h2>
                            <p class="text-gray-600 text-sm">
                                Model: <strong>LTG VRE 0400</strong> | Baseline @ 50Hz
                            </p>
                        </div>
                        <div class="hidden md:block text-right">
                            <div class="text-sm font-medium text-gray-500">Current Mode</div>
                            <div class="text-blue-600 font-bold">Simulation</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VFD SIMULATOR CONTENT -->
            <div class="space-y-6">
                <!-- 1. Results Section (Moved to Top) -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Card 1: Airflow -->
                    <div class="p-5 rounded-xl border border-gray-100 bg-white shadow-sm flex flex-col justify-between relative overflow-hidden transition-all hover:shadow-md">
                            <div class="absolute top-0 right-0 w-20 h-20 bg-cyan-50 rounded-bl-full opacity-50 -mr-4 -mt-4"></div>
                            <div>
                            <div class="flex items-center gap-2 mb-1">
                                <div class="p-2 rounded-lg bg-cyan-50 text-cyan-500"><i data-lucide="wind" class="w-4 h-4"></i></div>
                                <div><h3 class="font-bold text-gray-700 text-sm">Airflow</h3><p class="text-[10px] text-gray-400 font-mono">∝ Hz (Linear)</p></div>
                            </div>
                            <div class="mt-4"><span class="text-3xl font-bold text-cyan-600" id="resAirflow">5.60</span><span class="text-xs text-gray-400 ml-1">m³/s</span></div>
                            </div>
                            <div class="mt-3 pt-3 border-t border-gray-50 flex justify-between items-center">
                            <span class="text-xs text-gray-400">Linear</span>
                            <span class="text-xs font-bold px-2 py-1 rounded-full bg-green-100 text-green-700" id="pctAirflow">-20.0%</span>
                            </div>
                    </div>
                    <!-- Card 2: Pressure -->
                        <div class="p-5 rounded-xl border border-gray-100 bg-white shadow-sm flex flex-col justify-between relative overflow-hidden transition-all hover:shadow-md">
                            <div class="absolute top-0 right-0 w-20 h-20 bg-orange-50 rounded-bl-full opacity-50 -mr-4 -mt-4"></div>
                            <div>
                            <div class="flex items-center gap-2 mb-1">
                                <div class="p-2 rounded-lg bg-orange-50 text-orange-500"><i data-lucide="gauge" class="w-4 h-4"></i></div>
                                <div><h3 class="font-bold text-gray-700 text-sm">Pressure</h3><p class="text-[10px] text-gray-400 font-mono">∝ Hz² (Square)</p></div>
                            </div>
                            <div class="mt-4"><span class="text-3xl font-bold text-orange-600" id="resPressure">5024.00</span><span class="text-xs text-gray-400 ml-1">Pa</span></div>
                            <div class="text-[11px] text-gray-400 font-mono mt-1">≈ <span id="resPressureBar">0.05</span> bar</div>
                            </div>
                            <div class="mt-3 pt-3 border-t border-gray-50 flex justify-between items-center">
                            <span class="text-xs text-gray-400">Square</span>
                            <span class="text-xs font-bold px-2 py-1 rounded-full bg-green-100 text-green-700" id="pctPressure">-36.0%</span>
                            </div>
                    </div>
                    <!-- Card 3: Power -->
                        <div class="p-5 rounded-xl border border-gray-100 bg-white shadow-sm flex flex-col justify-between relative overflow-hidden transition-all hover:shadow-md">
                            <div class="absolute top-0 right-0 w-20 h-20 bg-red-50 rounded-bl-full opacity-50 -mr-4 -mt-4"></div>
                            <div>
                            <div class="flex items-center gap-2 mb-1">
                                <div class="p-2 rounded-lg bg-red-50 text-red-500"><i data-lucide="zap" class="w-4 h-4"></i></div>
                                <div><h3 class="font-bold text-gray-700 text-sm">Power</h3><p class="text-[10px] text-gray-400 font-mono">∝ Hz³ (Cube)</p></div>
                            </div>
                            <div class="mt-4"><span class="text-3xl font-bold text-red-600" id="resPower">38.40</span><span class="text-xs text-gray-400 ml-1">kW</span></div>
                            </div>
                            <div class="mt-3 pt-3 border-t border-gray-50 flex justify-between items-center">
                            <span class="text-xs text-gray-400">Cube</span>
                            <span class="text-xs font-bold px-2 py-1 rounded-full bg-green-100 text-green-700" id="pctPower">-48.8%</span>
                            </div>
                    </div>
                </div>

                <!-- 2. Main Layout (Inputs Left, Graph Right) -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Inputs -->
                    <div class="lg:col-span-1 space-y-6">
                        <!-- Target Config (Moved Up) -->
                        <div class="bg-blue-50 p-6 rounded-2xl shadow-sm border border-blue-100">
                            <div class="flex items-center gap-2 mb-4 text-blue-900">
                                <i data-lucide="sliders" class="w-5 h-5 text-blue-600"></i>
                                <h2 class="font-bold text-lg">1. ปรับความถี่ (Target)</h2>
                            </div>
                            <div class="mb-2 flex justify-between items-end">
                                <label class="text-sm font-medium text-gray-600">Set Frequency</label>
                                <div class="text-right">
                                    <span class="text-3xl font-bold text-blue-600"><span id="targetFreqDisplay">50</span> <span class="text-sm text-gray-500 font-normal">Hz</span></span>
                                    <div class="text-xs text-gray-500 font-mono">≈ <span id="resultRPMDisplay">2600</span> RPM</div>
                                </div>
                            </div>
                            <input type="range" id="targetFreq" min="0" max="60" step="0.5" value="50" class="w-full h-3 bg-blue-200 rounded-lg appearance-none cursor-pointer accent-blue-600" oninput="calculateVFD()">
                                <div class="mt-4 p-3 bg-white rounded-lg border border-blue-100 text-sm text-blue-800 flex items-center gap-2">
                                <i data-lucide="info" class="w-4 h-4"></i> <span>Speed Ratio: <strong id="speedRatioDisplay">100.0%</strong></span>
                            </div>
                        </div>

                        <!-- Base Config (Moved Down) -->
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-16 h-16 bg-blue-50 rounded-bl-full -mr-2 -mt-2"></div>
                            <div class="flex items-center justify-between mb-4 relative z-10">
                                <div class="flex items-center gap-2 text-blue-800">
                                    <i data-lucide="rotate-cw" class="w-5 h-5"></i>
                                    <h2 class="font-bold text-lg">2. สเปคพัดลม (Base)</h2>
                                </div>
                                <button onclick="resetVFD()" class="flex items-center gap-1 text-xs bg-gray-100 hover:bg-red-50 hover:text-red-600 text-gray-500 px-3 py-1.5 rounded-full transition-all border border-gray-200">
                                    <i data-lucide="rotate-ccw" class="w-3 h-3"></i> Reset
                                </button>
                            </div>
                            <div class="space-y-4 relative z-10">
                                <div class="flex items-center justify-between group">
                                    <div class="flex items-center gap-2 text-sm text-gray-600"><i data-lucide="activity" class="w-4 h-4"></i> Base Freq</div>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="baseFreq" class="w-24 text-right p-1.5 border border-gray-200 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none" value="50" oninput="calculateVFD()">
                                        <span class="text-xs text-gray-400 w-8">Hz</span>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between group">
                                    <div class="flex items-center gap-2 text-sm text-gray-600">Base RPM</div>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="baseRPM" class="w-24 text-right p-1.5 border border-gray-200 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none" value="2600" oninput="calculateVFD()">
                                        <span class="text-xs text-gray-400 w-8">RPM</span>
                                    </div>
                                </div>
                                <div class="border-t border-gray-100 my-2"></div>
                                    <div class="flex items-center justify-between group">
                                    <div class="flex items-center gap-2 text-sm text-gray-600"><i data-lucide="wind" class="w-4 h-4"></i> Airflow</div>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="baseAirflow" step="0.1" class="w-24 text-right p-1.5 border border-gray-200 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none" value="7.0" oninput="calculateVFD()">
                                        <span class="text-xs text-gray-400 w-8">m³/s</span>
                                    </div>
                                </div>
                                    <div class="flex items-center justify-between group">
                                    <div class="flex items-center gap-2 text-sm text-gray-600"><i data-lucide="gauge" class="w-4 h-4"></i> Pressure</div>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="basePressure" step="10" class="w-24 text-right p-1.5 border border-gray-200 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none" value="7850" oninput="calculateVFD()">
                                        <span class="text-xs text-gray-400 w-8">Pa</span>
                                    </div>
                                </div>
                                    <div class="flex items-center justify-between group">
                                    <div class="flex items-center gap-2 text-sm text-gray-600"><i data-lucide="zap" class="w-4 h-4"></i> Power</div>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="basePower" step="0.5" class="w-24 text-right p-1.5 border border-gray-200 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none" value="75.0" oninput="calculateVFD()">
                                        <span class="text-xs text-gray-400 w-8">kW</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Graph -->
                    <div class="lg:col-span-2">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 min-h-[400px] flex flex-col h-full">
                            <h3 class="font-bold text-blue-800 mb-6 flex items-center gap-2">
                                <span class="p-2 rounded-lg bg-blue-50 text-blue-600"><i data-lucide="line-chart" class="w-5 h-5"></i></span>
                                กราฟความสัมพันธ์ (Performance Curve)
                            </h3>
                            <div class="w-full relative flex-grow bg-slate-50 rounded-lg overflow-hidden border border-slate-100" id="vfdChartContainer">
                                <!-- SVG Chart will be injected here -->
                            </div>
                                <div class="mt-4 flex justify-center gap-6 text-sm">
                                <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-cyan-400"></div> Airflow (Linear)</div>
                                <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-orange-400"></div> Pressure (Square)</div>
                                <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-red-500"></div> Power (Cube)</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div> 
        <!-- Added missing closing div above for view-vfd -->

        <!-- ================= 4. COST ANALYSIS VIEW ================= -->
        <div id="view-cost" class="hidden fade-in">
             <!-- Cost Header -->
             <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100 mb-6">
                <div class="p-6 border-l-8 border-green-600 bg-white">
                        <div class="flex justify-between items-start">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-900 mb-2">
                                    วิเคราะห์ความคุ้มค่า (Cost Analysis)
                                </h2>
                                <p class="text-gray-600 text-sm">
                                    คำนวณจุดคุ้มทุนและพลังงานที่ประหยัดได้
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Inputs -->
                    <div class="lg:col-span-1 space-y-6">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-green-100">
                            <div class="flex items-center gap-2 mb-6 text-green-700">
                                <i data-lucide="calculator" class="w-6 h-6"></i>
                                <h2 class="font-bold text-xl">พารามิเตอร์การทำงาน</h2>
                            </div>
                            <div class="space-y-5">
                                 <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ชั่วโมงทำงานต่อวัน</label>
                                    <div class="relative">
                                        <input type="number" id="costHours" value="24" class="w-full p-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:outline-none text-right pr-12 text-lg font-semibold" oninput="calculateVFD()">
                                        <span class="absolute right-4 top-3.5 text-gray-400 text-sm">ชม.</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">วันทำงานต่อปี</label>
                                    <div class="relative">
                                        <input type="number" id="costDays" value="300" class="w-full p-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:outline-none text-right pr-12 text-lg font-semibold" oninput="calculateVFD()">
                                        <span class="absolute right-4 top-3.5 text-gray-400 text-sm">วัน</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ค่าไฟต่อหน่วย (THB/Unit)</label>
                                    <div class="relative">
                                        <input type="number" id="costUnit" value="3.99" step="0.01" class="w-full p-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:outline-none text-right pr-12 text-lg font-semibold" oninput="calculateVFD()">
                                        <span class="absolute right-4 top-3.5 text-gray-400 text-sm">บาท</span>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-8 p-4 bg-gray-50 rounded-xl text-sm text-gray-500 border border-gray-100">
                                <div class="flex justify-between mb-2">
                                    <span>Base Power (50Hz):</span>
                                    <span class="font-semibold text-gray-700" id="infoBasePower">75.00 kW</span>
                                </div>
                                 <div class="flex justify-between">
                                    <span>Target Power (<span id="infoTargetFreq">40</span>Hz):</span>
                                    <span class="font-semibold text-green-600" id="infoTargetPower">38.40 kW</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Analysis Dashboard -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- Savings Banner -->
                        <div class="bg-gradient-to-br from-green-600 to-green-700 rounded-2xl shadow-lg p-6 md:p-8 text-white relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-64 h-64 bg-white opacity-10 rounded-full -mr-16 -mt-16 blur-3xl"></div>
                            <div class="relative z-10 flex flex-col md:flex-row justify-between items-center gap-6">
                                <div>
                                    <h3 class="text-green-100 font-medium mb-1 flex items-center gap-2">
                                        <i data-lucide="piggy-bank" class="w-5 h-5"></i> ประหยัดค่าไฟได้ (Annual Savings)
                                    </h3>
                                    <div class="text-4xl md:text-6xl font-bold tracking-tight">
                                        <span id="txtSavingYear">1,185,840</span>
                                        <span class="text-2xl md:text-3xl font-normal opacity-80 ml-2">บาท/ปี</span>
                                    </div>
                                    <p class="mt-2 text-green-100 opacity-90">
                                        ลดลง <span class="font-bold bg-white/20 px-2 py-0.5 rounded" id="txtSavingPct">48.8%</span> เมื่อเทียบกับ Base Line
                                    </p>
                                </div>
                                <div class="bg-white/10 backdrop-blur-sm p-4 rounded-xl border border-white/20 text-center min-w-[180px]">
                                    <div class="text-xs text-green-100 uppercase tracking-wider mb-1">พลังงานที่ลดได้</div>
                                    <div class="text-2xl font-bold" id="txtEnergySaved">263,520</div>
                                    <div class="text-xs text-green-200">kWh / ปี</div>
                                </div>
                            </div>
                        </div>

                        <!-- Comparison Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Baseline -->
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                                 <div class="flex items-center justify-between mb-4">
                                    <h3 class="font-bold text-gray-500">BASELINE (50Hz)</h3>
                                    <span class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full"><span id="txtBaseFreq">50</span> Hz</span>
                                </div>
                                <div class="space-y-4">
                                    <div class="flex justify-between items-end">
                                        <span class="text-sm text-gray-600">ค่าไฟต่อเดือน</span>
                                        <div class="text-right">
                                            <div class="font-bold text-base text-gray-800" id="txtBaseCostMonth">202,500</div>
                                            <div class="text-[10px] text-gray-400">บาท</div>
                                        </div>
                                    </div>
                                    <div class="flex justify-between items-end pt-3 border-t border-gray-100">
                                        <span class="text-sm text-gray-600">ค่าไฟต่อปี</span>
                                        <div class="text-right">
                                            <div class="font-bold text-xl text-gray-800" id="txtBaseCostYear">2,430,000</div>
                                            <div class="text-[10px] text-gray-400">บาท</div>
                                        </div>
                                    </div>
                                    <div class="flex justify-between items-end">
                                        <span class="text-xs text-gray-400">พลังงานไฟฟ้า</span>
                                        <div class="text-right">
                                            <div class="font-normal text-sm text-gray-400" id="txtBaseEnergy">540,000</div>
                                            <div class="text-[10px] text-gray-400">kWh</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Target -->
                            <div class="bg-white p-6 rounded-2xl shadow-sm border-2 border-green-500 relative">
                                 <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-green-500 text-white text-xs font-bold px-3 py-1 rounded-full shadow-sm">แนะนำ</div>
                                 <div class="flex items-center justify-between mb-4">
                                    <h3 class="font-bold text-green-700">TARGET (<span id="txtTargetFreq">50</span>Hz)</h3>
                                    <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full"><span id="txtTargetFreq2">50</span> Hz</span>
                                </div>
                                <div class="space-y-4">
                                    <div class="flex justify-between items-end">
                                        <span class="text-sm text-gray-600">ค่าไฟต่อเดือน</span>
                                        <div class="text-right">
                                            <div class="font-bold text-base text-green-600" id="txtTargetCostMonth">103,680</div>
                                            <div class="text-[10px] text-gray-400">บาท</div>
                                        </div>
                                    </div>
                                    <div class="flex justify-between items-end pt-3 border-t border-gray-100">
                                        <span class="text-sm text-gray-600">ค่าไฟต่อปี</span>
                                        <div class="text-right">
                                            <div class="font-bold text-xl text-green-600" id="txtTargetCostYear">1,244,160</div>
                                            <div class="text-[10px] text-gray-400">บาท</div>
                                        </div>
                                    </div>
                                    <div class="flex justify-between items-end">
                                        <span class="text-xs text-gray-400">พลังงานไฟฟ้า</span>
                                        <div class="text-right">
                                            <div class="font-normal text-sm text-gray-400" id="txtTargetEnergy">276,480</div>
                                            <div class="text-[10px] text-gray-400">kWh</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="flex items-start gap-3 p-4 bg-yellow-50 text-yellow-800 rounded-xl text-sm border border-yellow-100">
                            <i data-lucide="info" class="flex-shrink-0 mt-0.5 w-4 h-4"></i>
                            <p>
                                การคำนวณนี้เป็นการประมาณการทางทฤษฎี (Theoretical Estimation) ตามกฎ Fan Laws โดยสมมติว่าประสิทธิภาพของมอเตอร์และ Inverter คงที่ และโหลดแปรผันตามความเร็วรอบจริง
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Initialize Lucide Icons
        lucide.createIcons();

        // --- GLOBAL STATE for DUCT CALCULATOR ---
        let ductState = {
            width_m: 0.6, height_m: 0.4, velocity_rated: 0, velocity_effective: 0,
            airflow_in: 7.0, flow_cms: 0, pressure_in: 0, pressure_out: 0,
            pressure_drop: 0, damper_percent: 50, isFanMode: false
        };

        // --- GLOBAL STATE for VFD SIMULATOR ---
        let vfdState = {
            baseFreq: 50, baseRPM: 2600, baseAirflow: 7.0, basePressure: 7850, basePower: 75.0,
            targetFreq: 50,
            costHours: 24, costDays: 300, costUnit: 3.99
        };

        // --- NAVIGATION LOGIC (UPDATED) ---
        function switchTab(tab) {
            // Updated view list to include 'cost'
            const views = ['calc', 'visual', 'vfd', 'cost'];
            const buttons = ['tab-calc', 'tab-visual', 'tab-vfd', 'tab-cost'];
            
            views.forEach(v => {
                const el = document.getElementById('view-' + v);
                if (el) { // Added null check
                    if(v === tab) {
                        el.classList.remove('hidden');
                        if(v === 'visual') startAnimation();
                    } else {
                        el.classList.add('hidden');
                        if(v === 'visual') stopAnimation();
                    }
                }
            });

            buttons.forEach(b => {
                const btn = document.getElementById(b);
                if (btn) { // Added null check
                    const isSelected = b === 'tab-' + tab;
                    if (isSelected) {
                        btn.className = "whitespace-nowrap px-4 py-2 rounded-md text-sm font-semibold transition-all shadow-sm bg-white text-blue-600";
                    } else {
                        btn.className = "whitespace-nowrap px-4 py-2 rounded-md text-sm font-semibold text-slate-500 hover:text-slate-700 transition-all";
                    }
                }
            });
        }

        // --- 1. DUCT CALCULATOR LOGIC ---
        function resetDuctValues() {
            document.getElementById('width').value = 600;
            document.getElementById('height').value = 400;
            document.getElementById('airflowIn').value = 7.0;
            document.getElementById('pressureIn').value = 7850;
            document.getElementById('damperOpen').value = 50;
            calculateDuct();
        }

        // NEW: Toggle Fan Mode directly
        function toggleFanMode() {
            const toggle = document.getElementById('fanModeToggle');
            toggle.checked = !toggle.checked;
            calculateDuct();
        }

        function calculateDuct() {
            const width_mm = parseFloat(document.getElementById('width').value) || 0;
            const height_mm = parseFloat(document.getElementById('height').value) || 0;
            const airflow_in = parseFloat(document.getElementById('airflowIn').value) || 0;
            const pressure_in = parseFloat(document.getElementById('pressureIn').value) || 0;
            const damper_percent = parseFloat(document.getElementById('damperOpen').value) || 0;
            const isFanMode = document.getElementById('fanModeToggle').checked;

            const width_m = width_mm / 1000;
            const height_m = height_mm / 1000;
            const area = width_m * height_m;
            document.getElementById('areaDisplay').innerText = `Area: ${area.toFixed(3)} m²`;

            let velocity_rated = 0;
            if (area > 0) velocity_rated = airflow_in / area;

            document.getElementById('damperPercentDisplay').innerText = damper_percent + "%";

            let effective_velocity = velocity_rated;
            let k_factor = 0;
            const closure = (100 - damper_percent) / 100;

            if (damper_percent <= 0) {
                k_factor = 999999;
            } else {
                k_factor = 0.3 + Math.pow(Math.E, (closure * 5)) - 1;
                if(damper_percent === 100) k_factor = 0.3;
            }

            let logicText = "";
            if (isFanMode) {
                let flow_reduction_factor = 1.0;
                if (damper_percent < 100) {
                    flow_reduction_factor = Math.max(0, 1 - (closure * 1.1)); 
                    flow_reduction_factor = Math.pow(flow_reduction_factor, 1.5);
                }
                effective_velocity = velocity_rated * flow_reduction_factor;
                logicText = `<ul class="list-disc list-inside mb-3"><li><span class="font-bold text-purple-600">โหมดจำลองพัดลม (Fan Mode):</span> คำนวณ Flow Drop ที่เกิดจากการหรี่ Damper</li></ul>`;
            } else {
                effective_velocity = velocity_rated;
                logicText = `<ul class="list-disc list-inside mb-3"><li><span class="font-bold text-blue-600">โหมดมาตรฐาน (Design Mode):</span> คำนวณหา Pressure Drop โดยคง Flow ไว้เท่าเดิม</li></ul>`;
            }

            logicText += `<div class="mt-3 pt-3 border-t border-slate-200"><p class="font-semibold text-slate-700 mb-2 text-xs uppercase tracking-wider">สูตรการคำนวณ</p><div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs font-mono text-slate-600"><div class="bg-white p-2 rounded border border-slate-100">ΔP = K × (0.5ρV²)</div><div class="bg-white p-2 rounded border border-slate-100">Pout = Pin - ΔP</div></div></div>`;
            document.getElementById('logicExplanation').innerHTML = logicText;

            const air_density = 1.2;
            const velocity_pressure = 0.5 * air_density * Math.pow(effective_velocity, 2);
            const pressure_drop = k_factor * velocity_pressure;
            let pressure_out = pressure_in - pressure_drop;
            const flow_cms = effective_velocity * area;
            const flow_cfm = flow_cms * 2118.88;

            ductState = { width_m, height_m, velocity_rated, velocity_effective: effective_velocity, airflow_in, flow_cms, pressure_in, pressure_out, pressure_drop, damper_percent, isFanMode };

            const pOutElem = document.getElementById('pressureOut');
            if (effective_velocity < 0.1 && damper_percent < 5) {
                document.getElementById('velocityOut').innerText = "0.00 m/s";
                pOutElem.innerText = "Blocked";
                document.getElementById('pressureDrop').innerText = "Max";
                document.getElementById('flowCMS').innerText = "0.000";
                document.getElementById('flowCFM').innerText = "0 ft³/min";
            } else {
                document.getElementById('velocityOut').innerText = effective_velocity.toFixed(2) + " m/s";
                pOutElem.innerText = pressure_out.toFixed(2);
                document.getElementById('pressureDrop').innerText = pressure_drop.toFixed(2) + " Pa";
                document.getElementById('flowCMS').innerText = flow_cms.toFixed(3);
                document.getElementById('flowCFM').innerText = flow_cfm.toFixed(0) + " ft³/min";

                if (pressure_out < 0) {
                    pOutElem.className = "text-4xl font-bold text-red-600 mt-2";
                    pOutElem.innerText = pressure_out.toFixed(2) + " (Low P)";
                } else {
                    pOutElem.className = "text-4xl font-bold text-slate-800 mt-2";
                }
            }

            let barPercent = 0;
            if (pressure_in > 0) barPercent = (Math.max(0, pressure_out) / pressure_in) * 100;
            const bar = document.getElementById('pressureBar');
            bar.style.width = `${barPercent}%`;
            bar.className = barPercent < 30 ? "bg-red-500 h-1.5 rounded-full transition-all duration-500" : "bg-blue-500 h-1.5 rounded-full transition-all duration-500";

            const insightBox = document.getElementById('resultInsightBox');
            if (isFanMode && damper_percent < 100 && effective_velocity < velocity_rated) {
                insightBox.classList.remove('hidden');
                document.getElementById('resultInsightText').innerHTML = `เมื่อหรี่แดมเปอร์ <b>Flow ลดลง</b> ทำให้ <b>Pressure Drop ลดลง</b> ตามไปด้วย`;
            } else {
                insightBox.classList.add('hidden');
            }
        }

        // --- 2. VFD SIMULATOR LOGIC ---
        function resetVFD() {
            document.getElementById('baseFreq').value = 50;
            document.getElementById('baseRPM').value = 2600;
            document.getElementById('baseAirflow').value = 7.0;
            document.getElementById('basePressure').value = 7850;
            document.getElementById('basePower').value = 75.0;
            document.getElementById('targetFreq').value = 50;
            calculateVFD();
        }

        function calculateVFD() {
            // Get values
            vfdState.baseFreq = parseFloat(document.getElementById('baseFreq').value) || 1;
            vfdState.baseRPM = parseFloat(document.getElementById('baseRPM').value) || 0;
            vfdState.baseAirflow = parseFloat(document.getElementById('baseAirflow').value) || 0;
            vfdState.basePressure = parseFloat(document.getElementById('basePressure').value) || 0;
            vfdState.basePower = parseFloat(document.getElementById('basePower').value) || 0;
            vfdState.targetFreq = parseFloat(document.getElementById('targetFreq').value) || 0;
            vfdState.costHours = parseFloat(document.getElementById('costHours').value) || 0;
            vfdState.costDays = parseFloat(document.getElementById('costDays').value) || 0;
            vfdState.costUnit = parseFloat(document.getElementById('costUnit').value) || 0;

            // Calculations
            const ratio = vfdState.targetFreq / vfdState.baseFreq;
            const resRPM = vfdState.baseRPM * ratio;
            const resAirflow = vfdState.baseAirflow * ratio;
            const resPressure = vfdState.basePressure * Math.pow(ratio, 2);
            const resPower = vfdState.basePower * Math.pow(ratio, 3);

            // Update Simulator UI
            document.getElementById('targetFreqDisplay').innerText = vfdState.targetFreq;
            document.getElementById('resultRPMDisplay').innerText = resRPM.toFixed(0);
            document.getElementById('speedRatioDisplay').innerText = (ratio * 100).toFixed(1) + "%";

            updateResultCard('Airflow', resAirflow, vfdState.baseAirflow);
            updateResultCard('Pressure', resPressure, vfdState.basePressure);
            updateResultCard('Power', resPower, vfdState.basePower);
            
            // Update Bar Unit
            document.getElementById('resPressureBar').innerText = (resPressure / 100000).toFixed(2);

            drawVFDChart(vfdState.baseFreq, vfdState.targetFreq);

            // Calculate Costs
            const baseEnergyYear = vfdState.basePower * vfdState.costHours * vfdState.costDays;
            const targetEnergyYear = resPower * vfdState.costHours * vfdState.costDays;
            const baseCostYear = baseEnergyYear * vfdState.costUnit;
            const targetCostYear = targetEnergyYear * vfdState.costUnit;
            const savingYear = baseCostYear - targetCostYear;
            const energySaved = baseEnergyYear - targetEnergyYear;
            const savingPct = baseCostYear > 0 ? (savingYear / baseCostYear) * 100 : 0;

            // Update Cost UI
            document.getElementById('infoBasePower').innerText = vfdState.basePower.toFixed(2) + " kW";
            document.getElementById('infoTargetPower').innerText = resPower.toFixed(2) + " kW";
            document.getElementById('infoTargetFreq').innerText = vfdState.targetFreq;

            document.getElementById('txtSavingYear').innerText = savingYear.toLocaleString(undefined, { maximumFractionDigits: 0 });
            document.getElementById('txtSavingPct').innerText = savingPct.toFixed(1) + "%";
            document.getElementById('txtEnergySaved').innerText = energySaved.toLocaleString(undefined, { maximumFractionDigits: 0 });

            // Baseline Card
            document.getElementById('txtBaseFreq').innerText = vfdState.baseFreq;
            document.getElementById('txtBaseCostMonth').innerText = (baseCostYear / 12).toLocaleString(undefined, { maximumFractionDigits: 0 });
            document.getElementById('txtBaseCostYear').innerText = baseCostYear.toLocaleString(undefined, { maximumFractionDigits: 0 });
            document.getElementById('txtBaseEnergy').innerText = baseEnergyYear.toLocaleString(undefined, { maximumFractionDigits: 0 });

            // Target Card
            document.getElementById('txtTargetFreq').innerText = vfdState.targetFreq;
            document.getElementById('txtTargetFreq2').innerText = vfdState.targetFreq;
            document.getElementById('txtTargetCostMonth').innerText = (targetCostYear / 12).toLocaleString(undefined, { maximumFractionDigits: 0 });
            document.getElementById('txtTargetCostYear').innerText = targetCostYear.toLocaleString(undefined, { maximumFractionDigits: 0 });
            document.getElementById('txtTargetEnergy').innerText = targetEnergyYear.toLocaleString(undefined, { maximumFractionDigits: 0 });

        }

        function updateResultCard(type, val, base) {
            document.getElementById('res' + type).innerText = val.toFixed(2);
            const pct = base > 0 ? ((val - base) / base) * 100 : 0;
            const el = document.getElementById('pct' + type);
            el.innerText = (pct > 0 ? '+' : '') + pct.toFixed(1) + "%";
            
            if (pct > 0) {
                el.className = "text-xs font-bold px-2 py-1 rounded-full bg-red-100 text-red-700";
            } else {
                el.className = "text-xs font-bold px-2 py-1 rounded-full bg-green-100 text-green-700";
            }
        }

        function drawVFDChart(base, current) {
            const container = document.getElementById('vfdChartContainer');
            // Check if container exists and has dimensions
            if (!container || container.clientWidth === 0) return;
            
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            // Use actual pixel dimensions for sharp rendering and correct aspect ratio
            const padding = 30;
            const w = width; 
            const h = height;
            
            // Curve logic: Max visualization range is 1.5x base frequency
            const maxVal = base * 1.5;
            
            // Scaling functions mapping value to pixel coordinates
            const getX = (val) => padding + (val / maxVal) * (w - 2*padding);
            // Y axis: normalized 0-1 ratio mapped to height. 
            // We use 3.5 as max Y ratio to accommodate Power curve (1.5^3 = 3.375)
            const getY = (ratio) => (h - padding) - (ratio / 3.5) * (h - 2*padding);

            let path1="", path2="", path3="";
            // Draw smooth curves with more segments
            const steps = 50;
            for(let i=0; i<=steps; i++) {
                const v = (i/steps) * maxVal;
                const r = v/base;
                const x = getX(v);
                path1 += `${i===0?'M':'L'} ${x},${getY(r)} `;
                path2 += `${i===0?'M':'L'} ${x},${getY(r*r)} `;
                path3 += `${i===0?'M':'L'} ${x},${getY(r*r*r)} `;
            }

            const curX = getX(current);
            const curR = current/base;
            
            // Generate SVG with dynamic viewbox matching container
            const svg = `
            <svg viewBox="0 0 ${w} ${h}" class="w-full h-full" style="overflow: visible;" preserveAspectRatio="none">
                <!-- Grid / Axes -->
                <line x1="${padding}" y1="${getY(1)}" x2="${w-padding}" y2="${getY(1)}" stroke="#e5e7eb" stroke-width="1" stroke-dasharray="4" />
                <text x="${padding}" y="${getY(1)-5}" font-size="10" fill="#9ca3af" font-family="sans-serif">Base (100%)</text>
                
                <line x1="${getX(base)}" y1="${padding}" x2="${getX(base)}" y2="${h-padding}" stroke="#e5e7eb" stroke-width="1" stroke-dasharray="4" />
                
                <!-- Curves -->
                <path d="${path3}" fill="none" stroke="#ef4444" stroke-width="2" />
                <path d="${path2}" fill="none" stroke="#fb923c" stroke-width="2" />
                <path d="${path1}" fill="none" stroke="#22d3ee" stroke-width="2" />
                
                <!-- Current Position Line -->
                <line x1="${curX}" y1="${padding}" x2="${curX}" y2="${h-padding}" stroke="#3b82f6" stroke-width="1.5" stroke-dasharray="4"/>
                
                <!-- Intersection Points -->
                <circle cx="${curX}" cy="${getY(curR)}" r="4" fill="#22d3ee" stroke="white" stroke-width="2" />
                <circle cx="${curX}" cy="${getY(curR*curR)}" r="4" fill="#fb923c" stroke="white" stroke-width="2" />
                <circle cx="${curX}" cy="${getY(curR*curR*curR)}" r="4" fill="#ef4444" stroke="white" stroke-width="2" />

                <!-- Axis Labels -->
                <line x1="${padding}" y1="${h-padding}" x2="${w-padding}" y2="${h-padding}" stroke="#64748b" stroke-width="1" />
                <line x1="${padding}" y1="${padding}" x2="${padding}" y2="${h-padding}" stroke="#64748b" stroke-width="1" />
                <text x="${w/2}" y="${h-10}" font-size="12" text-anchor="middle" fill="#64748b" font-weight="bold">Frequency (Hz)</text>
            </svg>
            `;
            container.innerHTML = svg;
        }

        // --- 3. CANVAS VISUALIZER (Re-used) ---
        const canvas = document.getElementById('ductCanvas');
        const ctx = canvas.getContext('2d');
        let animationId;
        let particles = [];
        let fanAngle = 0;

        function resizeCanvas() {
            if(canvas.parentElement) {
                canvas.width = canvas.parentElement.clientWidth;
                canvas.height = canvas.parentElement.clientHeight;
            }
        }
        window.addEventListener('resize', resizeCanvas);

        class Particle {
            constructor() { this.reset(); this.x = Math.random() * canvas.width; }
            reset() {
                this.x = 0;
                this.y = (canvas.height / 2 - 50) + Math.random() * 100;
                this.size = Math.random() * 2 + 1;
                this.speedBase = Math.random() * 2 + 1;
            }
            update(speedFactor) {
                this.x += this.speedBase * speedFactor;
                if (this.x > canvas.width) this.reset();
            }
            draw(ctx) {
                ctx.fillStyle = "rgba(100, 200, 255, 0.6)";
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function initParticles() {
            particles = [];
            for(let i=0; i<100; i++) particles.push(new Particle());
        }

        function drawDuct() {
            const hCenter = canvas.height / 2;
            const ductHeight = 120;
            ctx.strokeStyle = "#475569"; ctx.lineWidth = 4;
            ctx.beginPath(); ctx.moveTo(0, hCenter - ductHeight/2); ctx.lineTo(canvas.width, hCenter - ductHeight/2); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(0, hCenter + ductHeight/2); ctx.lineTo(canvas.width, hCenter + ductHeight/2); ctx.stroke();
            const grad = ctx.createLinearGradient(0, 0, canvas.width, 0);
            grad.addColorStop(0, "rgba(30, 41, 59, 0.2)"); grad.addColorStop(1, "rgba(30, 41, 59, 0.0)");
            ctx.fillStyle = grad; ctx.fillRect(0, hCenter - ductHeight/2, canvas.width, ductHeight);
        }

        function drawFan() {
            const hCenter = canvas.height / 2; const xPos = 80; const radius = 40;
            ctx.save(); ctx.translate(xPos, hCenter); ctx.rotate(fanAngle);
            ctx.fillStyle = "#3b82f6";
            for(let i=0; i<3; i++) { ctx.beginPath(); ctx.ellipse(0, -20, 10, 25, 0, 0, Math.PI * 2); ctx.fill(); ctx.rotate((Math.PI * 2) / 3); }
            ctx.fillStyle = "#1e293b"; ctx.beginPath(); ctx.arc(0,0, 10, 0, Math.PI*2); ctx.fill();
            ctx.restore();
            ctx.strokeStyle = "#64748b"; ctx.lineWidth = 2; ctx.beginPath(); ctx.arc(xPos, hCenter, radius + 5, 0, Math.PI*2); ctx.stroke();
            ctx.fillStyle = "#94a3b8"; ctx.font = "10px JetBrains Mono"; ctx.fillText("BLOWER", xPos - 20, hCenter + radius + 20);
        }

        function drawDamper() {
            const hCenter = canvas.height / 2; const xPos = canvas.width / 2; const ductHeight = 120;
            const pct = ductState.damper_percent; const angleRad = (pct / 100) * (Math.PI / 2);
            ctx.strokeStyle = "#f97316"; ctx.lineWidth = 2; ctx.strokeRect(xPos - 5, hCenter - ductHeight/2, 10, ductHeight);
            ctx.save(); ctx.translate(xPos, hCenter); ctx.rotate((Math.PI/2) - angleRad); 
            ctx.fillStyle = "#fdba74"; ctx.fillRect(-2, -50, 4, 100); 
            ctx.fillStyle = "#c2410c"; ctx.beginPath(); ctx.arc(0,0, 4, 0, Math.PI*2); ctx.fill();
            ctx.restore();
            ctx.fillStyle = "#fdba74"; ctx.fillText("DAMPER", xPos - 20, hCenter - ductHeight/2 - 10);
        }

        function updateVisualOverlay() {
            document.getElementById('visDamper').innerText = ductState.damper_percent + "%";
            document.getElementById('visPin').innerText = ductState.pressure_in;
            let pOut = ductState.pressure_out.toFixed(0);
            if(ductState.pressure_out < 0) pOut = "LOW"; else if(ductState.damper_percent === 0) pOut = "0";
            document.getElementById('visPout').innerText = pOut;
            document.getElementById('visFlow').innerText = ductState.flow_cms.toFixed(2);
            document.getElementById('visFlowIn').innerText = ductState.airflow_in.toFixed(2);
             const modeDisplay = document.getElementById('visModeDisplay');
            if (ductState.isFanMode) {
                modeDisplay.innerText = "MODE: FAN SIMULATION (CLICK)";
                modeDisplay.className = "px-3 py-1 rounded text-[10px] font-mono font-bold bg-purple-500/20 text-purple-400 border border-purple-500/50 shadow-[0_0_10px_rgba(168,85,247,0.2)] transition-colors duration-300 cursor-pointer hover:bg-purple-500/30 select-none";
            } else {
                modeDisplay.innerText = "MODE: STANDARD DESIGN (CLICK)";
                modeDisplay.className = "px-3 py-1 rounded text-[10px] font-mono font-bold bg-blue-500/20 text-blue-400 border border-blue-500/50 shadow-[0_0_10px_rgba(59,130,246,0.2)] transition-colors duration-300 cursor-pointer hover:bg-blue-500/30 select-none";
            }
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawDuct();
            let speedFactor = ductState.velocity_effective / 2;
            if(ductState.damper_percent === 0) speedFactor = 0;
            if(speedFactor > 0.1) fanAngle += 0.1 + (speedFactor * 0.05);
            drawFan();
            particles.forEach(p => {
                p.update(speedFactor);
                if(ductState.damper_percent < 10) {
                     if(p.x > canvas.width/2 - 10 && p.x < canvas.width/2 + 10) p.x = canvas.width/2 - 10;
                }
                p.draw(ctx);
            });
            drawDamper();
            updateVisualOverlay();
            animationId = requestAnimationFrame(animate);
        }

        function startAnimation() {
            resizeCanvas();
            initParticles();
            makeDraggable(document.getElementById('bubble_airflow_in'));
            makeDraggable(document.getElementById('bubble_inlet'));
            makeDraggable(document.getElementById('bubble_flow'));
            makeDraggable(document.getElementById('bubble_damper'));
            makeDraggable(document.getElementById('bubble_outlet'));
            if(!animationId) animate();
        }

        function stopAnimation() { cancelAnimationFrame(animationId); animationId = null; }

        // --- UTILS: DRAGGABLE ---
        function makeDraggable(elmnt) {
            let pos1=0,pos2=0,pos3=0,pos4=0;
            elmnt.onmousedown = dragStart; elmnt.ontouchstart = dragStart;
            function dragStart(e) {
                e = e || window.event;
                const rect = elmnt.getBoundingClientRect(); const parentRect = elmnt.offsetParent.getBoundingClientRect();
                elmnt.style.left = (rect.left - parentRect.left) + 'px'; elmnt.style.top = (rect.top - parentRect.top) + 'px';
                elmnt.style.right = 'auto'; elmnt.style.bottom = 'auto'; elmnt.style.transform = 'none';
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                pos3 = clientX; pos4 = clientY;
                document.onmouseup = closeDragElement; document.onmousemove = elementDrag;
                document.ontouchend = closeDragElement; document.ontouchmove = elementDrag;
                elmnt.style.cursor = 'grabbing'; elmnt.style.zIndex = '50';
            }
            function elementDrag(e) {
                e = e || window.event; e.preventDefault();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                pos1 = pos3 - clientX; pos2 = pos4 - clientY; pos3 = clientX; pos4 = clientY;
                elmnt.style.top = (elmnt.offsetTop - pos2) + "px"; elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
            }
            function closeDragElement() {
                document.onmouseup = null; document.onmousemove = null; document.ontouchend = null; document.ontouchmove = null;
                elmnt.style.cursor = 'grab'; elmnt.style.zIndex = '20';
            }
        }

        // Init
        calculateDuct();
        calculateVFD();
        // Add resize listener for chart
        window.addEventListener('resize', () => {
            const vfdView = document.getElementById('view-vfd');
            if(vfdView && !vfdView.classList.contains('hidden')) {
                calculateVFD();
            }
        });
        
        // Hide VFD initially
        switchTab('calc');

    </script>
</body>
</html>